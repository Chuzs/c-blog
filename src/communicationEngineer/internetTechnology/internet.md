---
# 这是文章的标题
title: 第三章 互联网
# 你可以自定义封面图片
cover: /assets/images/cover1.jpg
# 这是页面的图标
icon: fa-solid fa-file-lines
# 这是侧边栏的顺序
order: 3
# 设置作者
author: Mr.Chuzs
# 设置写作时间
date: 2023-08-29
# 一个页面可以有多个分类
category:
  - 通信工程师考试
# 一个页面可以有多个标签
tag:
  - 计算机网络
# 此页面会在文章列表置顶
sticky: true
# 此页面会出现在文章收藏中
star: true
# 你可以自定义页脚


# footer: 你走的每一步都算数
# 你可以自定义版权信息
# copyright: Copyright © 2023 Mr.Chuzs
---

`第三章` 互联网

一些网络互相连接组成的更大的网络称为`互联网` (Internet)；组成互联网的各个网络为`子网`（Sub Network）；用于连接子网的设备称为`中间系统` (Intermediate System，IS)，它主要作用是协调各个网络，使得跨网络的通信得以实现。`中间系统`可以是单独的设备，也司以是单独的网络。

## 1 网络互连设备

**作用**：连接不同的网络，在不改变原来网络体系结构的条件下，把一些异构型的网络互相连接成统的通信系统，实现更大范围的资源共享。

### 1.1 路由器

路由器工作在 `OSI/RM` 的`网络层`，**主要功能**：

- **网络互连**：路由器支持各种局域网和广域网接口，主要用于互连局域网和广域网实现不同网络互相通信;
- **数据处理**：提供包括分组过滤、分组转发、优先级、复用、加密、压缩和防火墙等功能;
- **网络管理**：路由器提供包括配置管理、性能管理、容错管理和流量控制等功能。

通常把网络层地址信息称为`网络逻辑地址`，把数据链路层地址信息称为`网络物理地址`。物理地址通常是由硬件制造商指定的，例如每块以太网卡都有一个48位的`MAC地址`，这种地址由`IEEE`管理，任何两个网卡不会有相的地址。逻辑地址也称为软件地址，用于网络层寻址，是由网络管理员在组网配置时指定的这种地址可以按照网络的组织结构及每个工作站的用途灵活设置，而且可以根据需要改变。路由器根据网络逻辑地址（而不是物理地址）在互连的子网之间传递分组。
路由器适合于连接复杂的大型网络，它工作于网络层，因而可以连接下面3层执行不同协议的网络，协议的转换由路由器完成，从而消除了网络层协议之间的差别，通过路由器连接的子网在网络层之上必须执行相同的协议。

### 1.2 网关

**主要功能**：

- 连接网络层之上执行不同协议的子网，组成异构型的互联网。
- 对互不兼容的高层协议进行转换，为了实现异构型设备之间的通信，
- 对不同的传输层、会话层、表示层、应用层协议进行翻译和转换。

`网关`是互连网络中操作在`传输层`之上的设施，之所以称为设施，是因为`网关`不一定是一台设备，有可能在一台主机中实现网关功能。当然也不排除使用一台计算机来实现。由于`网关`是实现互连、互通和应用互操作的设施，通常多是用来连接专用系统，所以市场上从未有过出售网关的现象。因此，在这种意义上，网关是一种概念，或一种功能的抽象.网关的范围很宽，在TCP/IP网络中，网关有时指的就是路由器。
由于工作复杂，因而用网关互连实效比较低，而且透明性不好，往往用于针对某种特殊用途的专用连接。最后，值得一提的是人们的习惯用语不同，并不像以上根据网络协议层的概念明确划分各种网络互连设备。有时并不区分路由器和网关，而把在网络层及其以上进行协议转换的互连设备统称为网关。

## 2 Internet协议

Intenet的主要协议是TCP和IP，所以Internet协议称为TCP/IP协议。与OSI/RM分层的原则不同，TCP/IP协议允许同层的协议实体间互相调用，从而完复杂的控制功能，也允许上层过程直接调用不相邻的下层过程，甚至在有些高层协议中，制信息和数据分别传输，而不是共享同一协议数据单元。

### 2.1 IP协议

1. **IP首部**
**首部组成**：每一行是32比特，4个字节，前20个字节的格式是固的，选项部分是可变的，数据部分就是上一层的协议数据。

   - **版本字段**，用来说明分组使用的协议的版本，这样，可以在不同版本的协议之间传递数据。
   IP首部长度不是固定的，因为其中包括了选项字段。首部长度字段占用4个比特，IP协议首部最长是60个字节，去掉20个固定的字节，选项最长是40个字节。
   - **服务类型字段**：使主机可以要求子网用不同的方式来处理数据报，主要是可靠性和速度比如，对于音频和视频而言，速度更主要，而文件则准确性更重要。
   - **总长度**：说明了数据报的中所有信息的大小，包括首部和数据，共16比特，最大值是2^16^-1=65535，以字节为单位。
   - **标识字段**：主要是解决不同类型的网络之间的通信问题。局域网有不同的类型，所允许传输的帧的最大长度不同，当一个数据报从一个网络传输过来，所去的网络帧的最大长度都无法封装下它时，只有把这个数据报分得更小一点，这就是网络中的分段。等这些分段到达主机时，再被重新组装成分组。标识字段就是用来说明这个分段是属于哪个分组的。
   - **标志字段**：有3个比特，其中最后一位用来标识是否还有分段，第一位现在已经不用，中间的一位标识是否允许分段。
   - **分段偏移**：用来说名分段在数据报中的位置，就像排队用的序号一样，当所有分段到达目的主机后，就根据它来重新组装分组。其长度是13比特，以8个字节为单位，所以一个分组最多可有2^13^=8192个分段，一个分组的最大长度是 2^13^*8=2^16^=65536字节，其实就是说的64KB，刚好和总长的最大值一致。特别注意一点，总长度是数据报的总长，不是分段长度。
   - **生存期**：即TTL。当一个分组经过一个路由器的时候，这个值会被减1，当这个值是0的时候，路由器会直接将这个分组丢掉，不再转发，从而避免一个分组在网络上“永久存在”
   - **协议字段**：当网络层一个完整的数据报组装完成后，告诉传输层由谁来处理这些数据
   - **首部校验和**：用来检验收到的这些分组是否正确，它只检查首部，在每个路由器上收到个分组后，都会进行这项工作，这是因为TTL总是不停地改变。

2. **IP地址**

在IP网络中，对网络上的每个设备，用IP地址进行标识。IP地址共有32位（每位占1比特），为了便于管理，对这些地址的不同位，进行了划分，IP地址被分成A、B、C、D和E5种类型，同时还把32位分成了网络号和主机号两大部分
对于A类网络，网络号使用一个字节，第一位是0，所以它的网络号范围是1~127。A类网络的主机号使用是后边的24位，可以拥有的主机数是2^24^-2，主机部分的全0代表的是网络号，全1是该网络的广播地址，因此要减去2个地址。对于任意一个网络来说，根据它的主机位数，就可以计算机它能拥有的最大主机数量，比如，B类，主机位数是16，它能拥有的最大主机数量是2^16^-2，依此类推，主机是n位，能拥有的最大主机数量是2^n^-2对于B类和C类网络来说，也是一样的，支持的网络个数分别是 2^14^-2和2^21^-2，能有的最大主机数分别是2^16^-2和2^8^-2
A类地址适用于规模较大，也就是主机数量比较多的网络，
B类适用于中等规模，
C类则是小规模的，因为它能拥有的主机数量最多254台·
IP地址被分成5类A、B和C是在网络中实际使用的，D类是用于广播的地址E类被保留作为研究使用，D和E不能直接在Internet上使用。
另外，网络中还有一些特殊需要，使用了一部分IP地址。32位都是1的IP地址是域网中的广播包，都是0代表本机，不管IP中的网络号是多少，如果主机位都是1，这分组就是这个网络的广播包；如果第一个字节是127，不管后边是多少，都是用来进行回路测试的。
二进制在实际使用的时候改用十进制表示，这就是`点分十进制`。32位的IP地址，分成4个字节，每个字节转换成十进制，中间用`.`来分隔。
3. **子网**

通过把大的网络划分成小的子网，管理网络。一个B类IP地址前导码和网络号占用了16位，主机号码16位，为了划分子网，用主机位的一部分作为子网号码，有子网时IP地址结构所示的用其中的6位作为子网号。这样的话，主机的位数变成16-6=10位。
这样就产生了网络号、子网号和主机号的IP地址结构。要根据一个IP地址来确定其网络号和子网号，需要用`子网掩码`和这个IP地址进行布尔与运算。规则很简单，上下都是1的时候为1，否则为0经过运算，得出网络号是159.160.28.0根据它就可以将这个分组转发到相应的网络中。
在工程中常常用202.106.2.0/26来表示网络号和子网掩码`/26`表示有26位的子掩码。

### 2.2 **ICMP协议**

网际控制信息协议（Intermet Control Message Protocol，ICMP）。在上网的过程中，使用IP的同时，也一直使用着ICMP。比如，当一个分组无法到达目的站点或TTL超时后，路由器就会丢弃此分组，并向源主机返回一个目的主机不可到达的ICMP报文。ICMP没有使用专用的数据报格式，它的首部使用了IP首部，如图3-1所示

::: center
**图3-1** **ICMP封装**
:::
| IP数据报首部 | ICMP数据 |
| :----------: | :------: |

ICMP数据部分都是ICMP定义，它的结构如图3-2所示

::: center
**图3-2** **ICMP数据报格式**
:::
<table>
   <tbody>
      <tr>
         <td>类型</td>
         <td>代码</td>
         <td>校验和</td>
      </tr>
      <tr>
         <td colspan="3">未使用</td>
      </tr>
      <tr>
         <td colspan="3">原IP首部和数据报</td>
      </tr>
   </tbody>
</table>

类型=11，表示是超时，也就是TTL=0了，然后又细分为转发超时和分段重组超时，编号分别是0和1，校验和计算从类型开始到数据报结束，这部分也就是ICMP消息。

原IP首部和数据报的前64位，作为ICMP的数据，用于主机匹配信息到相应的进程如果高层协议使用端口号，应该假设其在原分组的前64个字节中。

当发送一份ICMP差错报文时，报文始终包含IP的首部和产生ICMP差错报文的IP数据报的前8个字节。这样，接收ICMP差错报文的模块就会把它与某个特定的协议（根据I数据报首部中的协议字段来判断）和用户进程（根据包含在数据报前8个字节中的TCP或UDP报文首部中的TCP或UDP端口号来判断）联系起来。

为了防止过去允许ICMP差错报文对广播分组响应所带来的广播风暴，下面各种情况都不产生ICMP差错报文。

- ICMP差错报文（但是，ICMP查询报文可能会产生ICMP差错报文）。
- 目的地址是广播地址或多播地址的IP数据报。
- 作为数据链路层广播的数据报。
- 不是卫分段的第一段。
- 源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。
**ICMP应用**：检测网络、网络中的节点和主机的运行情况。常用的Ping使用的就是ICMP。

### 2.3 ARP和RARP协议

`网络层`的主要功能是在网络之间进行数据传输，IP对网络上的每个主机用一个IP地址来标识，在数据报中携带这个地址，网络中的设备会根据这个地址转发分组，但当数据报到了目的主机所在的局域网之后，就要打包成帧在局域网上传输，此时数据链路层需要目的机的MAC地址，而在IP数据报中是没有目的主机的MAC地址，这就需要根据目的主机IP地址得到其MAC地址，也就是IP地址和MAC地址的解析问题。为了解决这个问题，开发了`地址解析协议`(Address Resolution Protocol，ARP)。
**任务**：把IP地址转换成物理地址
**目的**：消除应用程序需要知道物理地址的必要性。
ARP工作的时候，会在存储器中维护一个ARP表，它的结构如表3-1所示。

::: center
**表3-1** **ARP表结构**
:::
<table>
  <thead>
    <tr>
      <th>——</th>
      <th>IF索引</th>
      <th>物理地址</th>
      <th>IP 地址</th>
      <th>类型</th>
    </tr>
  </thead>
  <tbody>
    <tr>
        <td>表项1</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>表项2</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>……</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>表项n</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
  </tbody>
</table>

ARPCache中的每一行对应一个设备，每一个设备存储以下信息
(1)IF索引，指物理端口(接口)。
(2)物理地址，指设备的物理地址。
(3)P地址，指和物理地址对应的P地址
(4)类型，指这一行对应的表项类型。
类型有4种可能的值，值2意味着表项是无效的，值3意味着映射是动态的(表项可能改变)，值4说明是静态项(表项不变化)，值1意味着不是上面的任何一种情况。
ARP格式如图3-3所示。当一个ARP请求发出时，除了接收端硬件地址(正是请求方想知道的)之外所有域都被使用。ARP应答中，使用所有的域。
::: center
**图3-3** **ARP请求和应答分组格式**
:::
<table>
  <thead>
    <tr>
      <th colspan="2">16位</th>
      <th colspan="2">16位</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>硬件地址长度</td>
      <td>协议地址长度</td>
      <td colspan="">操作码</td>
      <td colspan="">操作码</td>
    </tr>
    <tr>
      <td colspan="4">发送硬件地址(字节1~4)</td>
    </tr>
    <tr>
      <td colspan="2">发送硬件地址(字节5~6)</td>
      <td colspan="2">发送IP地址(字节1~2)</td>
    </tr>
    <tr>
      <td colspan="2">发送IP地址(字节3~4)</td>
      <td colspan="2">接收端硬件地址(字节1~2)</td>
    </tr>
    <tr>
      <td colspan="4">接收端硬件地址(字节3~6)</td>
    </tr>
    <tr>
      <td colspan="4">接收端IP地址</td>
    </tr>
  </tbody>
</table>

`硬件类型`用来识别硬件接口类型。`协议类型`用来标识发送设备所使用的协议类型，TCP/IP中，这些协议通常是 EtherType，如果协议不是 EtherType，允许使用其他值。数据报中硬件地址以及所用协议地址以字节为长度单位。
`操作码`指明数据报是ARP请求还是ARP应答，假如是ARP请求，此值为1；如果数报是ARP应答，此值为2。
ARP有一个缺陷：假如一个设备不知道它自己的IP地址，就没有办法产生ARP请求和ARP应答，网络上的无盘工作站就是这种情况。设备知道的只是网络接口卡上的物理地址，解决这一问题的一个简单办法是使用`反向地址解析协议`(Reverse AddressResofutionProtocol，RARP)，RARP以与ARP相反的方式工作。RARP发出要反向解析的物理地址并希望返回其IP地址，应答包括由能够提供信息的RARP服务器发出的P地址。虽然发送方发出的是广播信息，RARP规定只有RARP服务器能产生应答。

## 3 IPv6

随着互联网的迅速发展，当初设计IPv4时考虑不周所带来的缺陷日益显露出来，主要表现为两个方面：地址空间的用尽问题和路由表的急剧扩张问题，由此产生了IPV6。

### **3.1** **IPv6协议**

IPv6数据报头发生根本性改变，主要是提供对新的、更长的 128位IP地址的支持，以及去掉作废的和不用的域。

IP数据报头中的版本号4位长，记录数据报的版本号，IPv6中此数为6。优先级4位长，用于定义传输顺序的优先级。IPV6头中的优先级把数据报分成两类拥塞控制和非拥塞控制。非拥塞控制的报文比拥塞控制的报文优先路由。如果数据报有得控制，会对网络拥塞问题很敏感，拥塞发生时，会减慢数据的处理，报文会暂时存放在缓中直到问题解决。
流标识24位长，流标识和源机器IP地址一起提供网络流标识。为了防止缓存过大或出现一些过时的信息，IPv6规定缓存中维护的信息不能超过6秒如果一个具有相同流标识的数据报在6秒内没到达时，缓存项会被删除。为了防止发送机产生重复值，发送方必须等6秒才能使用相同的到另一目的机的流标识值。
报文长度16位，用于指示整个 数据报的长度，以字节为单位。整个长度不包括P自身。16位域的使用使最大值限制在65536内，但使用扩展头能对发送大数据报提供支持下一头用于标识哪一个应用跟在IP头之后。跳数限制域决定了数据报经过的最大跳费。每一次转发，该数值减1，当跳数限制减少到0时，数据报被丢弃，这一点和IP4中的TTL类似。

### **3.2** **IPv6地址**

IPv6和IPv4相比，最大的变化部分是IP地址的长度和结构。
IPv6改变了地址的分配方式，从用户拥有变成了ISP拥有。全球网络号由因特网地址配机构(IANA)分配给ISP，用户的全球网络地址是ISP地址空间的子集。每当用户改变ISP时，全球网络地址必须使用新的ISP提供的地址。这样，ISP 能有效地控制路由信息，避路由爆炸现象的出现。

1. **地址分类**
IPv6定义了3种不同的地址类型，分别是单播地址、多播地址和任意播地址。所有类的IPv6地址都是属于接口而不是节点。一个IPv6单播地址被赋给某一个接口，而一个接又只能属于某一个特定的节点，因此一个节点的任意一个接口的单播地址都可以用来标示节点。
IPv6中的单播地址是连续的，以位为单位的可掩码地址与带有CIDR的IPV4地址很类似一个标识符仅标识一个接口的情况。在IPv6中有多种单播地址形式，包括基于全局提供者单播地址、基于地理位置的单播地址、NSAP 地址、IPX 地址、节点本地地址、链路本地地
址和兼容IPv4的主机地址等。多播地址是一个地址标识符对应多个接口的情况（通常属于不同节点）。IPv6 多播地址用于表示一组节点。一个节点可能会属于几个多播地址。这个功能被多媒体应用程序所广泛使用，它们需要一个节点到多个节点的传输。RFC2373对于多点传送地址进行了更为详细的说明，并给出一系列预先定义的多播地址。
任意播地址也是一个标识符对应多个接口的情况。如果一个报文要求被传送到一个任点传送地址，则它将被传送到由该地址标识的一组接口中的最近一个(根据路由选择协议离度量方式决定)。由于任意播地址是从单点传送地址空间中划分出来的，因此它可以使用表示单点传送地址的任何形式。从语法上看，它与单播地址是没有差别的。当一个单播地址载指向多于一个接口时，该地址就成为任意播地址，并且被明确指明。当用户发送一个数据包到这个任意播地址时，离用户最近的一个服务器将响应用户。这对于一个经常移动和变更的网络用户大有益处。

2. **地址表示**
IPv4的地址长度是32位而Iv6的地址长度达到了128位是IPv4的4倍，表达起来的复杂程度也是IPv4地址的4倍。
IPv4地址表示为点分十进制格式，32位的地址分成4个8位分组，每个8位写成十进制。而IPv6的128位地址则是以16位为一分组每个16位分组写成4个十六进制数，中间用冒号分隔，称为冒号分十六进制格式。例如:21DA:00D3:0000:2F3B:02AA:0OFF:FE28:9C5A是一个完整的IPv6地址。
IPv6地址的基本表达方式是X:X:X:X:X:X:X:X，其中X是一个4位十六进制整数。这是比较标准的IPv6地址表达方式，如果在分配某种形式的IPv6地址时，发生包含长串0位的地址，为了简化包含0位地址的书写，指定了一个特殊的语法来压缩0。使用`::`符号指示有多个0值的16位组。`::`符号在一个地址中只能出现一次。该符号也能用来压缩地址中前部和尾部的0。
用下面的例子来说明:

|          标准格式          |       压缩格式        |  地址类型  |
| :------------------------: | :-------------------: | :--------: |
| 1080:0:0:0:8:800:200C:417A | 1080::8:800:200C:417A |  单播地址  |
|    FF01:0:0:0:0:0:0:101    |       FF01::101       |  多播地址  |
|      0:0:0:0:0:0:0:1       |          ::1          |  回返地址  |
|      0:0:0:0:0:0:0:0       |          ::           | 未指定地址 |

由于IPv4毕竟还在使用，完全过渡到IP6尚需时日，当谈到IPv4和IPv6混合使用的时候，采用另一种表示形式`x:x:x:x:x:x:d.d.d.d`。
其中，x是地址中6个高阶16位段的十六进制值，d是地址中4个低价8位段的十进制
值，也就是标准IPv4表示。举例说明:

|           标准格式           |       压缩格式       |
| :--------------------------: | :------------------: |
|     0:0:0:0:0:0:13.168.3     |     ::13.1.68.3      |
| 0:0:0:0:0:FFFF:129.144.52.38 | ::FFFF:129.144.52.38 |

此外,IPv6地址前缀的表示方式和IPv4地址前缀在CIDR中的表示方式很相似。一个IPv6地址前缀可以表示为如下形式IPv6地址/前缀长度。
这样，当书写节点地址和它的子网前缀二者时，可以组合成如下表示。
节点地址12AB:0:0:CD30:123:4567:89AB:CDEF和它的子网号12AB:0:0CD30::/60可以缩写成为12AB:0:0:CD30123:4567:89AB:CDEF/60
3. **地址配置**
IPv6的一个基本特性是它支持无状态和有状态两种地址自动配置的方式。无状态地址自动配置方式是获得地址的关键。IPv6 把自动将IP地址分配给用户的功能作为标准功能。只要机器一连接上网络便可自动设定地址。它有两个优点。一是最终用户不必花精力进行地址设定，二是可以大大减轻网络管理者的负担。IPv6有两种自动设定功能。一种是和IPv4自动设定功能一样的名为`全状态自动设定`功能。另一种是“无状态自动设定”功能。
在IPv4中，`动态主机配置协议`(Dynamic HostConiguration Protocol，DHCP)实现了主机P地址及其相关配置的自动设置。一个DHCP服务器拥有一个P地址池，主机从DHCP服务器租借IP地址并获得有关的配置信息(如缺省网关、DNS服务器等)，由此达到自动设置主机IP地址的目的。IPv6继承了IPv4的这种自动配置服务，并将其称为全自动配置

在无状态自动配置过程中，主机首先通过将它的网卡 MAC 地址附加在链接本地地址前缀`1111111010`之后，产生一个链路本地单播地址。接着主机向该地址发出一个被称为`邻居发现`的请求，以验证地址的唯一性。如果请求没有得到响应，则表明主机自我设置的链路本地单播地址是唯一的。否则，主机将使用一个随机产生的接口ID组成一个新的链路本地单播地址。然后，以该地址为源地址，主机向本地链路中所有路由器多点传送一个被称为路由器请求的配置信息。路由器以一个包含一个可聚集全球单播地址前缀和其他相关配置信息的路由器公告响应该请求。主机用他从路由器得到的全球地址前缀加上自己的接口ID，自动配置全球地址，然后就可以与 Internet中的其他主机通信了。使用无状态自动配置，无须手动干预就能够改变网络中所有主机的IP地址。例如，当企业更换了连接 Internet 的ISP时，将从新的ISP处得到一个新的可聚集全球地址前缀，ISP 把这个地址前缀从它的路由器上传送到企业路由器上。由于企业路由器将周期性地向本地链路中的所有主机多点传送路由器公告。因此企业网络中所有主机都将通过路由器公告收到新的地址前级，此后，它们就会自动产新的P地址并覆盖旧的P地址。

### 3.3 IPv4向IPv6过渡

**存在问题**：首部翻译，可能会导致数据丢失。IPv6 是以 IPv4 为基础的，但二者的首部非常不同。IP6首部中的任何不被IPv4支持的信息（如优先级分类）会在过程中被丢失。相反的，由IPv4 主机生成的报文转换为IPV6报文时将会丢失大量信息，其中有一些可能是重要信息。

一些TCP/IP 服务到IPv6 的转变需要很长的时间。比如DNS，保存了通用名字到IP址的映射，当IPv6出现时，DNS将不得不处理两个IP版本，并且要为每个主机解析多个IP地址。

IPv4的广播也会有问题，因为经常会出现局域网范围或广域网范围的用IPv4发出的播报文；IPv6使用多播来减少广播，这个特性允许广播报文在局域网或广域网上只经过一次，在转换期间涉及两个广播系统就会成为问题。

目前，解决过渡问题基本技术主要有3种`双协议栈`(RFC2893)、`隧道技术`(RFC2893)、`协议翻译技术`(RFC2766)。

- **双协议栈**
  - **定义**：采用该技术的节点上同时运行IPv4和IPv6两套协议栈这是使IPv6节点保持与纯PW节点兼容最直接的方式，针对的对象是通信端节点（包括主机、路由器）。
  - **缺点**：对IPv4和IPv6提供了完全的兼容，但是对于地址耗尽的问题却没有任何帮助。由于需要双路由基础设施，这种方式反而增加了网络的复杂度。

- **隧道技术**
  - **定义**：以现有IPv4路由体系来传递IPv6数据：将IPv6的分组作为无结构意义的数据，封装在IPv4数据报中，被IPv4网络传输。根据建立方式的不同隧道可以分成两类：手工配置的隧道和自动配置的隧道。
  - **缺点**：使IPv6的节点之间能够在过渡期间通信，但它并不能解决IPv6节点与IPv4节点之间相互通信的问题
  
- **协议翻译技术**
  - **Iv4地址和IPV6地址转换**：在IPv4和IPv6网络之间转换IP报头的地址
  - **协议翻译**：根据协议不同对分组做相应的语义翻译，使纯IPv4和纯IPv6站点之间能够透明通信。

## 4 Internet路由协议

Internet就是成千上万个IP子网通过路由器互连起来的国际性网络。在网络中，路由器不仅负责对IP分组的转发，还要负责与别的路由器进行联络，共同确定`网间网`的路由选择，并维护路由表。

路由动作包括两项基本内容：`寻径`和`转发`。

- **寻径**：确定到达目的地的最佳路径，由路由选择算法实现。
- **转发**：按照确定好的最佳路径传送信息分组。

典型的路由选择方式有两种：`静态路由`和`动态路由`。

- **静态路由**：是在路由器中设置的固定路由表。由于静态路由不能对网络的改变做出反应，一般用于网络规模不大、拓扑结构固定的网络中。静态路由的优点是简单、高效和可靠。在所有的路由中，静态路由优先级最高。当动本路由与静态路由发生冲突时，以静态路由为准。
- **动态路由**：网络中的路由器之间相互通信，传递路由信息，利用收到的路由信息更新路由表的过程。它能实时地适应网络结构的变化。如果路由更新信息表明网络发生了变化，路由选择软件就会重新计算路由，并发出新的路由更新信息。这些信息通过各个网络，引起各路由器重新启动其路由算法，并更新各自的路由表以动态地反映网络拓扑变化。动态路由话用于网络规模大、网络拓扑复杂的网络。当然，各种动态路由协议会不同程度地占用网络带宽和CPU资源。

静态路由和动态路由有各自的特点和适用范围，因此在网络中动态路由通常作为静态路由的补充。当一个分组在路由器中进行寻径时，路由器首先查找静态路由，如果查到，则根据相应的静态路由转发分组：否则再查找动态路由。

根据是否在一个自治域内部使用，动态路由协议分为`内部网关协议`和`外部网关协议`。

- **自治域**：指一个具有统一管理机构、统一路由策略的网络。
- **内部网关协议**：自治域内部采用的路由选择协议，常用的是RIP和OSPF；
- **外部网关协议**：主要用于多个自治域之间的路由选择，常用的是BGP和BGP4。

### 4.1 RIP协议

`路由信息协议`(Routing Information Protocol，RIP)是使用最广泛的一种内部网关协议。它依靠物理网络的广播功能来迅速交换选路信息。

RIP的基础就是基于本地网的矢量距离选路算法的直接而简单的实现。它把参与通信的机器分为主动的和被动的。主动路由器向其他路由器通告其路由，而被动路由器接收通告并在此基础上更新其路由，它们自己并不通告路由。只有路由器能以主动方式使用RIP，而主机只能使用被动方式。

以主动方式运行RIP的路由器每隔30s广播一次报文，该报文包含了路由器当前的选路数据库中的信息。每个报文由序偶构成，每个序偶由一个卫网络地址和一个代表到达该网络的距离的整数构成。RIP使用跳数度量来衡量到达目的站的距离。在RIP度量标准中，路由器到它直接相连的网络的跳数被定义为1，到通过另一个路由器可达的网络的距离为2跳，其余依次类推。因此，从给定源站到目的站的一条路径的跳数对应于数据报沿该路传输时经过的路由器数。显然，使用跳数作为衡量最短路径并不一定会得到最佳结果。例如，经过3个以太网的跳数为3的路径，可能比经过两条低速行线的跳数为2的路径要快得多。为了补偿传输技术上的差距，许多RIP软件在通告低速网络路由时人为地增加了跳数。

运行RIP的主动机器和被动机器都要监听所有的广播报文，并根据前面所说的矢量距算法来更新其选路表。RIP 规定所有收听者必须对通过 RIP获得的路由设置定时器。当路器在选路表中设置新路由时，它也为之设定了定时器。当该路由器又收到关于该路由的另个广播报文后，定时器也要重新设置。如果经过180s后还没有下一次通告该路由，它就变为无效路由。

RIP必须处理下层算法的3类错误：

- 由于算法不能明确地检测出选路的回路，RIP要么假定参与者是可信赖的，要么采取一定的预防措施。
- RIP必须对可能的距离使用一个较小的最大值来防止出现不稳定的现象 (RIP 使用的值是 16)。因而，对于那些实际数值在 16左右的互连网络，管理者要么把它划分为若干部分，要么采用其他的协议。
- 第三选路更新报文在网络之间的传输速率很慢，RIP 所使用的矢量距离算法会产生慢收敛或无计数问题，从而引发不一致性。选择一个小的无限大值（16），可以限制慢收敛问题，但不能彻底解决客观存在。

RIP报文大致可分为两类：`选路信息报文`和`对信息的请求报文`。它们都使用同样的格式由固定的首部和后面可选的网络和距离序偶列表组成。图3-4所示为报文的格式，命令字段按照规定对应各种操作。在32比特的首部之后，报文包含了一系列网络和距离序偶列表,每个序偶由一个网络IP地址和一个到达该网络的整数距离值构成。

::: center
**图3-4** **RIP报文的格式**
:::
<table>
  <thead>
    <tr>
      <th>8位</th>
      <th>8位</th>
      <th>8位</th>
      <th>8位</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>命令(1~5)</td>
      <td>版本(1)</td>
      <td colspan="2">必为零</td>
    </tr>
    <tr>
      <td colspan="2">网1的协议族</td>
      <td colspan="2">必为零</td>
    </tr>
    <tr>
      <td colspan="4">网1的IP地址</td>
    </tr>
    <tr>
      <td colspan="4">必为零</td>
    </tr>
    <tr>
      <td colspan="4">必为零</td>
    </tr>
    <tr>
      <td colspan="4">至网1的距离</td>
    </tr>
     <tr>
      <td colspan="2">网2的协议族</td>
      <td colspan="2">必为零</td>
    </tr>
    <tr>
      <td colspan="4">网2的IP地址</td>
    </tr>
    <tr>
      <td colspan="4">必为零</td>
    </tr>
    <tr>
      <td colspan="4">必为零</td>
    </tr>
    <tr>
      <td colspan="4">至网2的距离</td>
    </tr>
    <tr>
      <td colspan="4">……</td>
    </tr>
  </tbody>
</table>

RIP的普遍适用性也体现在它传送网络地址的方式上。它的地址格式不局限于供TCP/IP用户使用，还能适应其他网络协议族的规定。图3-4中，RIP通告中的每个网络地址可以长达14个八位组。当然，IP地址仅需4个八位组，RIP定义余下的八位组必须为零。网络协议族字段指出了解释它后面出现的网络地址时应遵循的协议族。

除了正常的IP地址之外，RIP规定地址0.0.0.0作为默认路由。RIP对通告的每个路由包括默认路由，都附加了距离度量标准。因此，可以让两个路由器以不同的度量标准来通告默认路由(如到互连网络的其余部分的路由)，选择其中的一条作为基本路径，另一条作为备用。

在RIP报文每个项目的最后一个字段是到网络i的距离字段，其内容是到达指定网络的整数型距离值。距离值是以跳数作为度量单位的，但是它的取值范围限制在1~16，16代表无限远(即该路由不存在)。

RIP报文中并没包含显式的长度字段。相反，RIP假设底层投递系统能够告诉接收方收到的报文长度。特别是，在TCP/IP 系统中，RIP报文依赖于UDP来告诉接收方报文的长度RIP工作在UDP上的端口是520，虽然RIP可以不同的UDP端口来发送请求报文，但是在接收端的UDP端口通常都是520，同时这也是RIP产生广播报文的源端口。

RIP简单、易实现，在一些小型网络中得到普遍应用。

### 4.2 OSPF协议

OSPF路由协议是一种典型的链路状态(Link-State)路由协议，一般用于同一个路由域内。在这里，路由域是指一个自治系统(Autonomous System，AS)，是一组通过统一的路由政策或路由协议互相交换路由信息的网络。在这个AS中，所有的OSPF路由器都维护一个相同的描述这个AS结构的数据库，该数据库中存放的是路由域中相应链路的状态信息，OSPF路由器正是通过这个数据库计算出其OSPF路由表的。

1. **链路状态算法**
作为一种典型的链路状态的路由协议，OSPF还必须遵循链路状态路由协议的统一算法：
当路由器初始化或当网络结构发生变化(如增减路由器，链路状态发生变化等)时路由器会产生链路状态广播(Link-State Advertisement，LSA)数据包该数据包中包含路由器上所有相连链路，即为所有端口的状态信息。
所有路由器会通过一种被称为洪泛(Flooding)的方法来交换链路状态数据Flooding是指路由器将其LSA数据包传送给所有与其相邻的OSPF路由器，相邻路由器根据其接收到的链路状态信息更新自己的数据库，并将该链路状态信息转发给与其相邻的路由器，直至稳定的一个过程。
当网络重新稳定下来，即OSPF路由协议收敛后，所有的路由器会根据其各自的链路状态信息数据库计算出各自的路由表。该路由表中包含路由器到每一个可到达目的地的Cost，以及到达该目的地所要转发的下一个路由器。
当网络状态比较稳定时，网络中传递的链路状态信息是比较少的
第4个步骤实际上是指OSPF路由协议的一个特性

2. **区域及域间路由**
在OSPF路由协议的定义中可以将一个路由域或者一个自治系统(Autonomous System，AS)划分为几个区域在OSPF中，由按照一定的OSPF路由法则组合在一起的一组网络或路由器的集合称为区域。
在OSPP路由协议中，每一个区域中的路由器都按照该区域中定义的链路状态算法计算网络拓扑结构，这意味着每一个区域都有该区域独立的网络拓扑数据库及网络拓扑图。对于每一个区域，其网络拓扑结构在区域外是不可见的，同样，在每一个区域中的路由器对我外的其余网络结构也不了解。SPF 路由城中的网络链路状态数据广播被区域的边界挡这样做有利于减少网络中链路状态数据包在全网范围内的广播，也是 OSPF 将其路由域个AS划分成很多个区域的重要原因。
可以根据IP数据包的目的地址及源地址将OSPF路由域中的路由分成两类，当目的场源地址处于同一个区域中时，称为`区域内路由`，当目的地与源地址处于不同的区域甚至外不同的AS时，称为`域间路由`。

3. **OSPF路由器分类**
当一个AS划分成几个OSPF区域时，根据一个路由器在相应的区域之内的作用，可将OSPF路由器作如下分类。
**内部路由器**：当一个OSPF路由器上所有直连的链路都处于同一个区域时，称这种路器为内部路由器。内部路由器上仅运行其所属区域的OSPP运算法则。
**区域边界路由器**：当一个路由器与多个区域相连时，称为区域边界路由器。区域边装路由器运行与其相连的所有区域定义的 OSPF 运算法则，具有相连的每一个区域的网络构数据，并且了解如何将该区域的链路状态信息广播至骨于区域，再由骨于区域转发至箕余区域。
**AS边界路由器**：AS边界路由器是与AS外部的路由器互相交换路由信息的OSPF路器，该路由器在AS内部广播其所得到的AS外部路由信息;这样AS内部的所有路由器都道AS边界路由器的路由信息。AS 边界路由器的定义是与前面几种路由器的定义相独立的一个AS边界路由器可以是一个区域内部路由器，或是一个区域边界路由器。
**指定路由器**：在一个广播性的、多接入的网络(如Ethernet、TokenRing及FDDI环境)中，存在一个指定路由器(Designated Router，DR)指定路由器主要在OSPF协议中完成如
下工作。
(1)指定路由器产生用于描述所处的网段的链路数据包——Network Link，该数据包中包含在该网段上所有的路由器，包括指定路由器本身的状态信息。
(2)指定路由器与所有与其处于同一网段上的OSPF路由器建立相邻关系。OSPF路器之间，通过建立相邻关系和以后的Floodig进行链路状态数据库同步，因此可以说指定路由器处于一个网段的中心地位。
DR的选择是通过OSPF的Hello数据包来完成的，在OSPF路由协议初始化的过程中会通过Hello数据包在一个广播性网段上选出一个ID最大的路由器作为指定路由器DR并且选出D次大的路由器作为备份指定路由器(Backup Designated Router，BDR)，BDR在DR发生故障后能自动替代DR的所有工作。当一个网段上的DR和BDR选择产生后，该网段上的其余路由器都只与DR及BDR建立相邻关系。在这里，一个路由器的ID是指向该路由器的标识，一般是指该路由器的环回端口或是该路由器上的最小的IP地址。

4. OSPF协议工作过程
OSPF路由协议针对每一个区域分别运行一套独立的计算法则，对于区域边界路由器来说，由于一个区域边界路由器同时与几个区域相连，因此一个区域边界路由器上会同时运行几套OSPF计算方法，每一个方法针对一个OSPF区域。下面介绍OSPF协议运算全过程。
（1）区域内部路由
当一个OSPF路由器初始化时，先初始化路由器自身的协议数据库，然后等待低层次协议(数据链路层)提示端口是否处于工作状态。
如果低层协议得知一个端口处于工作状态时，OSPF会通过其Hello协议数据包与其余的OSPF路由器建立交互关系。一个OSPF路由器向其相邻路由器发送Hello数据包，如果接收到某一路由器返回的Hello数据包，则在这两个OSPP路由器之间建立起OSPF交互关系，这个过程在OSPF中被称为Adjacency。在广播性网络或是在点对点的网络环境中，OSPF协议通过Bello数据包自动地发现其相邻路由器这时OSPF路由器将Helo数据包发送至一特殊的多点广播地址，该多点广播地址为ALLSPFRouters。在一些非广播性的网络环境中，需要经过某些设置来发现OSPF相邻路由器。在多接入的环境中，如以太网的环境，Hello协议数
据包还可以用于选择该网络中的指定路由器(DesignatedRouter，DR)。一个OSPF路由器会与其新发现的相邻路由器建立OSPF的Adjacency,并且在一对OSPF路由器之间作链路状态数据库的同步。在多接入的网络环境中，非DR的OSPF路由器只会与指定路由器DR建立Adjacency，并且做数据库的同步。OSPF协议数据包的接收及发送正
是在一对OSPF的Adiacency间进行的。OSPF路由器周期性地产生与其相连的所有链路的状态信息，有时这些信息也被称为LSA。当路由器相连接的链路状态发生改变时，路由器也会产生链路状态广播信息，所有这些广播数据是通过Flood的方式在某一个OSPF区域内进行的。Flooding算法是一个非常可靠的计算过程，它保证在同一个OSPP区域内的所有路由器都具有一个相同的OSPF数据库根据这个数据库，OSPF路由器会将自身作为根，计算出一个最短路径树，然后该路由器会根据最短路径树产生自己的OSPF路由表。
（2）建立OSPF交互关系Adjacency
OSPF路由协议通过建立交互关系来交换路由信息，但并不是所有相邻的路由器都会建立OSPF交互关系。下面简要介绍OSFP建立Adjacency 的过程。
OSPF协议是通过Hello协议数据包来建立及维护相邻关系的，同时也用其来保证相邻路由器之间的双向通信。OSPF路由器会周期性地发送Hello数据包，当这个路由器看到自身被列于其他路由器的Hello数据包里时，这两个路由器之间会建立起双向通信。在多接入的环境中，Hello数据包还用于发现DR，通过DR来控制与哪些路由器建立交互关系。
两个OSPF路由器建立双向通信之后的第二个步骤是进行数据库的同步，数据库同步是所有链路状态路由协议的最大共性。在OSPF 路由协议中，数据库同步关系仅仅在建立交互关系的路由器之间保持。
OSPF的数库同步是通过OSPF数据库描述数据包进行的，OSPF路由器周期性地产生数据库播描述数据包。该数据包是有序的，即附带有序列号，并将这些数据包对相邻路由器广播、相邻路由器可以根据数据库播述数据包的序列号与自身数据库的数据作比较。收到的数据比数据库内的数据序列号大，则相邻路由器会针对序列号较大的数据发出请求，并用请求得到的数据来更新其链路状态数据库。
将OSPF相邻路由器从发送Hello数据包，建立数据库同步至建立完全的OSPF的过程分成几个不同的状态：
**Down**：这是 OSPF建立交互关系的初始化状态，表示在一定时间之内没有接收到从某一相邻路由器发送来的信息。在非广播性的网络环境内，OSPF 路由器还可能对处Down态的路由器发送Hello数据包。
**Attempt**：该状态仅在NBMA 环境，如中帧中继、X.25或ATM 环境中有效，表示在一定时间内没有接收到某一相邻路由器的信息，但是 OSPF 路由器仍必须以一个较低的频率相邻路由器发送Hello数据包来保持联系。
**Init**：在该状态时，OSPF 路由器已经接收到相邻路由器发送来的 Hello 数据包，但的IP地址并没有出现在该 Hello数据包内，也就是说，双方的双向通信还没有建立
**2-Way**：这个状态可以说是建立交互方式真正的开始步骤。在这个状态，路由器看身己经处于相邻路由器的Hello数据包内，双向通信已经建立。指定路由器及备份指定路由器的选择正是在这个状态完成的。在这个状态，OSPF路由器还可以根据其中的一个路由器是否指定路由器或是根据链路是否点对点或虚拟链路来决定是否建立交互关系。
**Exstart**:这个状态是建立交互状态的第一个步骤。在这个状态，路由器要决定用于数据交换的初始的数据库描述数据包的序列号,以保证路由器得到的永远是最新的链路状态信息。同时，在这个状态路由器还必须决定路由器之间的主备关系，处于主控地位的路由器会向处于备份地位的路由器请求链路状态信息。
**Exchange**:在这个状态，路由器向相邻的OSPF路由器发送数据库描述数据包来交换链路状态信息，每一个数据包都有一个数据包序列号。在这个状态，路由器还有可能向相邻路由器发送链路状态请求数据包来请求其相应数据。从这个状态开始，可以说OSPF处于Flooding状态。
**Loading**:在Loading 状态，OSPF 路由器会就其发现的相邻路由器的新的链路状态数据及自身的已经过期的数据向相邻路由器提出请求，并等待相邻路由器的回答。
**Full**：这是两个OSPP路由器建立交互关系的最后一个状态，此时，建立起交互关系的路由器之间已经完成了数据库同步的工作，它们的链路状态数据库已经一致。
（3）域间路由
前面描述了OSPF路由协议的单个区域中的计算过程。在单个OSPF区域中，OSPF路由协议不会产生更多的路由信息。为了与其余区域中的OSPF路由器通信，该区域的边界路器会产生一些其他的信息对域内广播，这些附加信息描绘了在同一个AS中的其他区域的由信息。具体路由信息交换过程如下。
在OSPF的定义中，所有的区域都必须与区域0相连，因此每一个区域都必须有一个区域边界路由器与区域0相连，这一个区域边界路由器会将其相连接的区域内部结构数据通Summary Link广播至区域0，也就是广播至所有其他区域的边界路由器。这时，与区域0相连的边界路由器上有区域0及其他所有区域的链路状态信息。通过这些信息，这些边界路由器能够计算出至相应目的地的路由，并将这些路由信息广播至与其相连接的区域，以便让该区域内部的路由器找到与区域外部通信的最佳路由。
(4)AS外部路由
一个自治域AS的边界路由器会将AS外部路由信息广播至整个AS中除了残域的所有区域。为了使这些AS外部路由信息生效，AS内部的所有路由器(除残域内的路由器)都必须知道AS边界路由器的位置，该路由信息是由非残域的区域边界路由器对域内广播的，其链路广播数据包的类型为类型4。
(5)OSPF路由协议验证
在OSPF路由协议中，所有的路由信息交换都必须经过验证。在前文所描述的OSPP协议数据包结构中，包含有一个验证域及一个64位长度的验证数据域，用于特定的验证方式的计算。
OSPF数据交换的验证是基于每一个区域来定义的，也就是说，当在某一个区域的一个路由器上定义了一种验证方式时，必须在该区域的所有路由器上定义相同的协议验证方式。另外，一些与验证相关的参数也可以基于每一个端口来定义，如当采用单一口令验证时，可以对某一区域内部的每一个网络设置不同的口令字。在OSPF路由协议的定义中，初始定义了两种协议验证方式:`验证方式0`及`验证方式1`
验证方式0:表示OSPF对所交换的路由信息不验证。在OSPF的数据包头内64位的验证数据位可以包含任何数据，OSPF接收到路由数据后对数据包头内的验证数据位不作任何处理。
验证方式1:验证方式1为简单口令字验证。这种验证方式是基于一个区域内的每一个网络来定义的,每一个发送至该网络的数据包的包头内都必须具有相同的64位长度的验证数据位，也就是说验证方式1的口令字长度为64bit，或者为8B。

### 4.3 BGP协议

BGP是因特网选路的实际标准，能为Internet提供一种可控制的无循环的路由。BGP没有对基础因特网拓扑施加任何限制。它假定自治系统内部的选路已经通过自治系统内的选路协议完成了。基于在BGP相邻体之间交换的信息，BGP构造了一个自治系统图。就BGP而论，这个因特网就是一个AS图，每个AS用AS号码来识别。两个AS之间的连接形成一个路径，路径信息汇集成到达特定目的地的路由。BGP确保无循环域间选路。
BGP是用来在自治系统之间传递选路信息的`路径向量协议`。术语`路径向量`来自这一事实，即BGP选路信息带有一个AS号码的序列，它指出一个路由已通过的路径BGP把TCP当作它的传送协议(端口179)这就保证了所有的传送可靠性。
两个BGP路由器相互间构成传送协议的连接这两个路由器就称为相邻体或对等体。对等路由器交换多种报文以开放并确认连接参数，如两个对等体间运行的BGP的版本。例如：BGP3是第3版，BGP4就是第4版。如果对等体之间有什么不一致，就会有差错通知发送，这个对等体连接就不会建立。
最初，所有候选BGP路由都被交换。当网络信息改变时，就发送增量的更新。就 CPU 开销及带宽分配与前面协议(如 EGP)使用的完整的定期更新相比较而言，增量更新的方法体现了巨大的改进。
在一对BGP 路由器之间，路由以Update 报文通告。Update 报文包括一个<长度，前缀数组的列表，它表示通过每个系统可到达的目的地的列表。Update 报文还包括路径属性，如某个特定路由的优先级别的信息。
如果信息改变了，如一个路由难以到达或有了更多的路径，BGP就会通过撤销无效路由注入新的选路信息，来告知它的相邻体。撤销的路由是 Update 报文的一部分。它们是不能再供使用的路由。如果没有发生路由改变，路由器只交换Keepalive数据包。
Keepalive报文在BGP相邻体之间周期地发送，以确保连接保持有效。Keepalive数据(每个数据包19B)不会导致路由器CPU或链路带宽的紧张，因为它们只占用最小的带宽(约2.5bit/s，每周期60s)。
BGP保存了一个表格的版本号，以便跟踪 BGP 路由表的情况。如果表格改变了，BGP就增加表格的版本。表格版本的迅速增加通常表示网络的不稳定。
BGP报文报头格式是一个16B的标记字段，接着是2B的长度字段和1B的类型字段图3-19 所示为BGP报文头的基本格式。
报头后面接或不接数据部分都可以，这要依据报文的类型而定，如 Keepalive 报文，只需要报文报头，没有着任何数据。标记字段可以用来鉴别进入的BGP报文或者检测两个BGP对等体间同步的丢失。标记字段可有两种格式。
如果报文类型是Open或者这个Open报文没有鉴别信息，标记字段必须全为“1”否则，标记字段会基于所使用的鉴别技术的一部分被计算。
长度：整个BGP报文包括报头的长度。最短的BGP报文不会小于19B(16+2+1)，不会大于4096B
类型：报文的类型，分别是Open、Update、Notifcation和Keepalive。

## 5 城域网

### 5.1 城域网的含义和结构

城域网是指介于局域网和广域网之间，在城市和郊区范围内实现信息传输和交换的一种网络。宽带卫城域网是宽带骨干网络在城市范围内的延伸，是在城市范围内，以IP技术为基础，以光纤作为传输介质，承载数据、语音、视频等多媒体业务，为用户提供高带宽、多功能、多业务接入的多媒体通信网络。它能够满足政府机关、企事业单位、个人用户对基于IP的各种多媒体业务的需求，特别是日益增长的互联网用户高速上网的需求。
宽带IP城域网由IP城域网骨干网和城域接入网组成，其中骨干网包括核心层、业务接入控制层和汇聚层。城域接入网实现接入层，提供最终用户的接入。

1、核心层
核心层主要负责业务接入控制层和汇聚层数据的快速转发，以及整个城域网路由表的维护，同时实现与IP广域骨干网的互连，提供城市的高速卫数据出口。
楼心层设备一般应选用高速路由器。核心层网络结构原则上核心节点间采用网状够状连接。

2.业务接入控制层
业务接入控制层实现城域网用户的接入认证控制、QoS 策略控制和计费统计等功能，负责转接汇聚层的流量。
业务接入控制层设备为宽带网络网关 (Broadband Network Gate，BNG)。BNG相关功能可由一台设备完成，也可单独设置为业务路由器(Service Router，SR)、宽带接入服(Broadband Remote Access Server, BRAS)、多业务边缘路由器 (Mutiple Service Edge, MSE)核心层节点与业务接入控制节点采用星形连接，在光纤数量可以保证的情况下，每个业务接入控制节点最好能够与两个核心层节点相连。

3.汇聚层
汇聚层提供基本的数据收敛、转发，汇聚来自城域接入网的流量。大规模的IP城域网数据据业务发展情况可将汇聚层分为城域汇聚层和区域汇聚层。
汇聚层节点设备一般采用3层交换机。为提高业务性能并避免以太网广播泛滥等间汇聚交换机仅设置一级。在接入网采用 LAN 方式时，汇聚交换机和接入交换机总级数建议不超过两级。

4.接入层
宽带IP城域骨干网之下是城域接入网，即接入层。接入层提供各种类型用户的就近接入。通过各种接入技术和线路资源实现对用户的覆盖，并提供多业务的用户接入，必要时配合完成用户流量控制。
传统的接入层设备一般采用2层或3层交换机或综合接入设备，位置根据实际网络环境中的用户数量、距离和密度等情况设置。接入层网络结构采用星形。接入方式主要有两种一种是光纤+LAN，适用于用户密集区域，如小区个人用户、集团用户、政府机关等，另种是XDSL或CableModem，适用于有电话线或有线电视网的区域。

### 5.2 宽带IP城域网的路由及传输技术

1. 城域网路由协议
为了保证城域网的相对独立性，一般情况下城域网自成一个自治域，与省骨干网路由完全隔离。这样做一方面可以保持城域网路由的灵活性，在路由设置和IP地址分配方面有大的自由度，另一方面也可以减少城域的路由动荡对省网路由的冲击。
IP城域网与上级省IP骨干网之间采用域间路由协议 BGP-4进行路由沟通，在自治选用合适的IGP，IGP应采用动态路由协议OSPF或IS-IS。

2. 城域网传输技术
宽带P城域网的骨干网络部分的传送技术可采用OTN、通过路由器设备的POS、以网端口经光纤直连等。大规模宽带 城域网的核心层节点间可以通过 PTN、OTN或光纤连连接。大规模宽带卫城域网的汇聚层节点间，以及中小规模宽带  城域网的核心层节汇聚层节点间可以通过SDH/MSTP、PTN、OTN、光纤直连连接。

### 5.3 宽带IP城域网的认证技术

宽带IP城域网通过适当配置BNG设备，与后台业务支撑系统一起形成IP城域网的业务控制点与网络接入控制点，实现对IP城域网用户的业务接入控制和管理。宽带IP城域网的用户身份认证采用AAA机制和RADIUS协议。宽带用户接入认证有PPPoE、DHCP+、802.1x等接入认证方式。

1、AAA与RADIUS协议
AAA(AuthenticationAuthorizationAccounting.AAA)是认证、授权和计费的简称，它提供了一个用来对认证、授权和计费这3种安全功能进行配置的一致的框架。AAA的配置实际上是对网络安全的一种管理。这里的网络安全主要指访问控制。包括哪些用户可以访问网络服务器，具有访问权的用户可以得到哪些服务，如何对正在使用网络资源的用户进行计费。
认证、授权和计费各自的作用如下。

- 认证(Authentication):认证用户是否可以获得访问权
- 授权(Authorization):授权用户可以使用哪些服务。
- 计费(Accounting):记录用户使用网络资源的情况

RADIUS协议被设计用于AAA。1996年5月，RADIUS协议开始被IETF认可为AAA方面的工业标准。
RADIUS协议采用客户机/服务器(Client/Server)结构。客户端通常运行于网络接入服务器(Network Access Server，NAS)上，它的职责是将用户的信息发送到指定的RADIUS服务器，是连接用户和RADIUS服务器之间的桥梁。
RADIUS服务器通常运行于工作站或服务器上，其职责是接收客户端发来的用户认证请求信息，完成对用户的认证，同时将提供服务所需要的配置信息返回给客户端，并对用户开始进行计费。RADIUS服务器数据库中的相关安全信息采用了集中存放的方式，避免安全信息凌乱散布带来的不安全性，同时更可靠且易于管理。

2、PPPOE接入认证技术
PPPOE通过将以太网和点对点协议PPP的可扩展性及管理控制功能结合在一起，实现对用户的接入认证和计费等功能。
PPPoB技术既能实现一个客户端与多个远程主机连接的功能，又能够提供类似于PPP的访问控制和计费功能。使用PPPOE 技术，类似于使用点对点协议的拨号服务方式，每个主机使用自己的点对点协议栈，用户使用自己所熟悉的拨号网络用户接口进行拨号。通过PPPOB技术，每个用户可以有自己的接入管理、计费和业务类型。
PPPoE技术比较成熟，是传统PSTN窄带拨号接入技术在以太网接入技术上的延伸。特点是:可以防止地址冲突与地址盗用，可以按时长计费，也可以按流量计费，能够对特定用户设置访问列表过滤或防火墙功能:能够对特定用户访问网络的速率进行控制:能够利用现有的用户认证、管理和计费系统，易于实现宽窄带用户的统一管理认证和计费，能够方便地提供动态业务选择特性。缺点是多播业务开展困难，难以支持视频业务。

3.DHCP+认证技术
传统的DHCP是用一台DHCP服务器集中地进行按需自动配置P地址DHCP+对传统的DHCP进行了改进主要增加了认证功能,即DHCP服务器在将配置参数发给客户端之前，必须将客户端提供的用户名和密码送往RADIUS服务器进行认证，通过后才将配置信息发给
